<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Manager - ClickDescubra 2025</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .status {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .status-icon.loading {
            background: #ffc107;
        }

        .status-icon.success {
            background: #28a745;
        }

        .status-icon.error {
            background: #dc3545;
        }

        .main-content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4facfe;
        }

        .question-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .option-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .option-input input[type="radio"] {
            width: auto;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(238, 90, 82, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(64, 192, 87, 0.4);
        }

        .questions-list {
            display: grid;
            gap: 20px;
        }

        .question-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }

        .question-card:hover {
            border-color: #4facfe;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .question-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .question-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            flex-grow: 1;
            margin-right: 15px;
        }

        .question-meta {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 15px;
        }

        .question-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .option {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .option.correct {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .option.incorrect {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            color: #495057;
        }

        .question-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            opacity: 0.9;
        }

        .group-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }

        .group-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #495057;
        }

        .group-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(251, 140, 0, 0.4);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab.active {
            color: #4facfe;
            border-bottom-color: #4facfe;
        }

        .tab:hover {
            color: #4facfe;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .image-upload-group {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: border-color 0.3s;
        }

        .image-upload-group:hover,
        .image-upload-group.dragover {
            border-color: #4facfe;
            background-color: #f8f9ff;
        }

        .image-preview {
            max-width: 300px;
            max-height: 200px;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .image-upload-btn {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px 5px;
        }

        .image-remove-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .question-image {
            max-width: 200px;
            max-height: 150px;
            border-radius: 6px;
            margin: 10px 0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .no-image-placeholder {
            color: #999;
            font-style: italic;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 6px;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🎯 Quiz Manager</h1>
            <p>Gerencie as perguntas do ClickDescubra 2025</p>
        </div>

        <div class="status">
            <div class="status-item">
                <div class="status-icon loading" id="statusIcon"></div>
                <span id="statusText">Carregando...</span>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="loadQuestions()">
                    🔄 Recarregar
                </button>
                <button class="btn btn-primary" onclick="downloadAllImages()">
                    📥 Exportar Imagens
                </button>
            </div>
        </div>

        <div class="main-content">
            <!-- Stats -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalGroups">0</div>
                    <div class="stat-label">Total de Grupos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalQuestions">0</div>
                    <div class="stat-label">Total de Perguntas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="categoriesCount">0</div>
                    <div class="stat-label">Categorias</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgTime">0s</div>
                    <div class="stat-label">Tempo Médio</div>
                </div>
            </div>

            <!-- Alert Messages -->
            <div id="alertContainer"></div>

            <!-- Schedule Section -->
            <div class="section">
                <h2 class="section-title">⏰ Agendamento do Quiz</h2>
                <div class="question-form">
                    <p style="margin-bottom: 20px; color: #666;">
                        Configure o período em que o quiz estará disponível para os jogadores.
                        Deixe os campos vazios para o quiz estar sempre disponível.
                    </p>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="startDate">📅 Data de Início:</label>
                            <input type="date" id="startDate">
                        </div>
                        <div class="form-group">
                            <label for="startTime">🕐 Hora de Início:</label>
                            <input type="time" id="startTime">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="endDate">📅 Data de Término:</label>
                            <input type="date" id="endDate">
                        </div>
                        <div class="form-group">
                            <label for="endTime">🕐 Hora de Término:</label>
                            <input type="time" id="endTime">
                        </div>
                    </div>

                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong>Status Atual:</strong>
                        <div id="scheduleStatus" style="margin-top: 10px; font-size: 16px;">
                            Carregando...
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="saveSchedule()">
                            💾 Salvar Agendamento
                        </button>
                        <button class="btn btn-warning" onclick="clearSchedule()">
                            🗑️ Remover Agendamento (sempre disponível)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('groups')">📂 Grupos</button>
                <button class="tab" onclick="switchTab('questions')">📝 Perguntas</button>
                <button class="tab" onclick="switchTab('ranking')">🏆 Ranking</button>
                <button class="tab" onclick="switchTab('config')">⚙️ Configurações</button>
            </div>

            <!-- Groups Tab -->
            <div id="groupsTab" class="tab-content active">
                <!-- Add/Edit Group Form -->
                <div class="section">
                    <h2 class="section-title" id="groupFormTitle">➕ Adicionar Novo Grupo</h2>
                    <div class="question-form">
                        <div class="form-group">
                            <label for="groupName">Nome do Grupo (opcional):</label>
                            <input type="text" id="groupName" placeholder="Deixe vazio para usar 'Grupo X'">
                            <small style="color: #666;">Se deixar vazio, será usado "Grupo 1", "Grupo 2", etc.</small>
                        </div>

                        <div class="form-group">
                            <label for="groupMessage">Mensagem de Conclusão:</label>
                            <textarea id="groupMessage" placeholder="Mensagem exibida ao completar este grupo..."></textarea>
                        </div>

                        <div id="groupFormActions">
                            <button class="btn btn-primary" onclick="addGroup()">
                                ➕ Adicionar Grupo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Groups List -->
                <div class="section">
                    <h2 class="section-title">📂 Grupos Existentes (máximo 5)</h2>
                    <div id="groupsList">
                        <!-- Groups will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Questions Tab -->
            <div id="questionsTab" class="tab-content">
                <!-- Add/Edit Question Form -->
                <div class="section">
                    <h2 class="section-title" id="formTitle">➕ Adicionar Nova Pergunta</h2>
                <div class="question-form">
                    <div class="form-group">
                        <label for="questionText">Pergunta:</label>
                        <textarea id="questionText" placeholder="Digite sua pergunta aqui..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Imagem da Pergunta (opcional):</label>
                        <div class="image-upload-group" id="imageUploadArea">
                            <div id="imagePreviewContainer">
                                <p>🖼️ Clique para adicionar uma imagem ou arraste aqui</p>
                                <input type="file" id="questionImage" accept="image/*" style="display: none;">
                                <button type="button" class="image-upload-btn"
                                    onclick="document.getElementById('questionImage').click()">
                                    📎 Escolher Imagem
                                </button>
                            </div>
                        </div>
                        <small style="color: #666;">Formatos aceitos: JPG, PNG, GIF. Tamanho máximo: 2MB</small>
                    </div>

                    <div class="form-group">
                        <label>Opções de Resposta:</label>
                        <div class="options-grid">
                            <div class="option-input">
                                <input type="radio" name="correctOption" value="0" id="correct0">
                                <input type="text" id="option0" placeholder="Opção 1">
                            </div>
                            <div class="option-input">
                                <input type="radio" name="correctOption" value="1" id="correct1">
                                <input type="text" id="option1" placeholder="Opção 2">
                            </div>
                            <div class="option-input">
                                <input type="radio" name="correctOption" value="2" id="correct2">
                                <input type="text" id="option2" placeholder="Opção 3">
                            </div>
                            <div class="option-input">
                                <input type="radio" name="correctOption" value="3" id="correct3">
                                <input type="text" id="option3" placeholder="Opção 4">
                            </div>
                        </div>
                        <small style="color: #666;">Selecione o botão de rádio da resposta correta</small>
                    </div>

                    <div class="form-group">
                        <label for="questionGroup">Grupo:</label>
                        <select id="questionGroup">
                            <option value="">Selecione um grupo...</option>
                        </select>
                        <small style="color: #666;">Selecione em qual grupo esta pergunta pertence</small>
                    </div>

                    <div class="form-group">
                        <label for="category">Categoria:</label>
                        <input type="text" id="category" placeholder="Ex: Geografia, História, Ciências...">
                    </div>

                    <div class="form-group">
                        <label for="timeSeconds">Tempo (segundos):</label>
                        <input type="number" id="timeSeconds" value="20" min="5" max="60">
                    </div>

                    <div id="formActions">
                        <button class="btn btn-primary" onclick="addQuestion()">
                            ➕ Adicionar Pergunta
                        </button>
                    </div>
                </div>
            </div>

                <!-- Questions List -->
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 class="section-title" style="margin: 0;">📝 Perguntas Existentes</h2>
                        <div class="form-group" style="margin: 0; width: 300px;">
                            <label for="filterGroup" style="margin-bottom: 5px;">Filtrar por Grupo:</label>
                            <select id="filterGroup" onchange="filterQuestionsByGroup()">
                                <option value="">Todos os Grupos</option>
                            </select>
                        </div>
                    </div>
                    <div id="questionsList" class="questions-list">
                        <!-- Questions will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Ranking Tab -->
            <div id="rankingTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">🏆 Ranking dos Jogadores</h2>

                    <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="loadRanking()">
                            🔄 Recarregar Ranking
                        </button>
                        <button class="btn btn-primary" onclick="exportRankingToCSV()">
                            📥 Exportar para CSV
                        </button>
                    </div>

                    <div style="overflow-x: auto;">
                        <table id="rankingTable" style="width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden;">
                            <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <tr>
                                    <th style="padding: 15px; text-align: left;">🏅 Colocação</th>
                                    <th style="padding: 15px; text-align: left;">👤 Nome</th>
                                    <th style="padding: 15px; text-align: left;">📧 Email</th>
                                    <th style="padding: 15px; text-align: left;">📱 Telefone</th>
                                    <th style="padding: 15px; text-align: left;">💼 Cargo</th>
                                    <th style="padding: 15px; text-align: center;">🎯 Pontuação</th>
                                    <th style="padding: 15px; text-align: center;">⏱️ Tempo</th>
                                </tr>
                            </thead>
                            <tbody id="rankingTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                                        Carregando ranking...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="rankingStats" style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <!-- Stats cards will be added here -->
                    </div>
                </div>
            </div>

            <!-- Config Tab -->
            <div id="configTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">⚙️ Configurações de API</h2>

                    <div style="margin-bottom: 20px; padding: 15px; background: #ffebee; border-radius: 8px; border-left: 4px solid #f44336;">
                        <strong>🚨 Sobre o Erro CORS:</strong>
                        <p style="margin: 10px 0 0 0; line-height: 1.6;">
                            Se você viu erro "blocked by CORS policy", é <strong>normal</strong>!
                            O servidor <code>https://jogos.clickideia.com.br</code> precisa adicionar headers CORS para funcionar no gerenciador web.
                            <br><br>
                            <strong>✅ Mas isso não afeta a aplicação Unity!</strong> Unity não precisa de CORS, então você pode:
                        </p>
                        <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                            <li>Usar JSONBin.io no gerenciador web (funciona perfeitamente)</li>
                            <li>Usar servidor customizado na aplicação Unity (sem erro CORS)</li>
                            <li>Ou configurar CORS no servidor para usar servidor customizado em ambos</li>
                        </ul>
                    </div>

                    <div class="question-form">
                        <p style="margin-bottom: 20px; color: #666;">
                            Configure qual servidor será usado para armazenar os dados do quiz.
                        </p>

                        <div class="form-group">
                            <label><strong>Tipo de API:</strong></label>
                            <div style="display: flex; gap: 20px; margin-top: 10px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="apiType" value="jsonbin" checked onchange="toggleAPIConfig()">
                                    <span style="margin-left: 8px;">📦 JSONBin.io (Padrão)</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="apiType" value="customServer" onchange="toggleAPIConfig()">
                                    <span style="margin-left: 8px;">🌐 Servidor Customizado</span>
                                </label>
                            </div>
                        </div>

                        <!-- JSONBin Config -->
                        <div id="jsonbinConfig" style="margin-top: 30px;">
                            <h3 style="color: #667eea; margin-bottom: 15px;">📦 Configurações JSONBin.io</h3>

                            <div class="form-group">
                                <label>API Key:</label>
                                <input type="text" id="jsonbinApiKey" value="$2a$10$Uu3NdRpmfPSc0b2MNV0PY.mKluWPCevjK7ioHlXr4AlMca/HC2V9y" readonly style="background: #f5f5f5;">
                            </div>

                            <div class="form-group">
                                <label>Quiz Bin ID:</label>
                                <input type="text" id="jsonbinQuizBinId" value="68e7598543b1c97be95fbb4d" readonly style="background: #f5f5f5;">
                            </div>

                            <div class="form-group">
                                <label>Ranking Bin ID:</label>
                                <input type="text" id="jsonbinRankingBinId" value="68e75972ae596e708f0b701f" readonly style="background: #f5f5f5;">
                            </div>

                            <div class="form-group">
                                <label>Registration Bin ID:</label>
                                <input type="text" id="jsonbinRegistrationBinId" value="68ed827aae596e708f1217dc" readonly style="background: #f5f5f5;">
                            </div>
                        </div>

                        <!-- Custom Server Config -->
                        <div id="customServerConfig" style="margin-top: 30px; display: none;">
                            <h3 style="color: #667eea; margin-bottom: 15px;">🌐 Configurações Servidor Customizado</h3>

                            <div class="form-group">
                                <label>Base URL:</label>
                                <input type="text" id="customBaseUrl" value="https://jogos.clickideia.com.br" placeholder="https://seu-servidor.com">
                            </div>

                            <div class="form-group">
                                <label>Quiz Endpoint:</label>
                                <input type="text" id="customQuizEndpoint" value="/QuizData.json" placeholder="/QuizData.json">
                            </div>

                            <div class="form-group">
                                <label>Ranking Endpoint:</label>
                                <input type="text" id="customRankingEndpoint" value="/RankingData.json" placeholder="/RankingData.json">
                            </div>

                            <div class="form-group">
                                <label>Registration Endpoint:</label>
                                <input type="text" id="customRegistrationEndpoint" value="/Register.json" placeholder="/Register.json">
                            </div>

                            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #ffc107;">
                                <strong>⚠️ Requisitos do Servidor Customizado:</strong>
                                <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                                    <li><strong>Métodos HTTP:</strong> GET e POST</li>
                                    <li><strong>Arquivos JSON:</strong> Devem existir e ser acessíveis publicamente</li>
                                    <li><strong>CORS (Critical!):</strong> Configurar headers no servidor:
                                        <ul style="margin-top: 5px;">
                                            <li><code>Access-Control-Allow-Origin: *</code></li>
                                            <li><code>Access-Control-Allow-Methods: GET, POST, OPTIONS</code></li>
                                            <li><code>Access-Control-Allow-Headers: Content-Type</code></li>
                                        </ul>
                                    </li>
                                    <li><strong>Para Unity:</strong> CORS não é necessário (apenas para web)</li>
                                </ul>
                                <p style="margin: 10px 0 0 0; padding: 10px; background: #fff; border-radius: 4px; font-size: 13px;">
                                    <strong>💡 Dica:</strong> Se você vir erro "blocked by CORS policy" no console, significa que o servidor não está configurado corretamente.
                                    A aplicação Unity não terá esse problema, apenas o gerenciador web.
                                </p>
                            </div>
                        </div>

                        <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                            <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 10px 0; color: #1976d2;">📋 Configuração Atual:</h4>
                                <div id="currentConfig" style="font-family: monospace; font-size: 14px; color: #666;">
                                    Carregando...
                                </div>
                            </div>

                            <button class="btn btn-primary" style="font-size: 18px; padding: 15px; width: 100%; margin-bottom: 15px;" onclick="applyConfigAndReload()">
                                🔄 Aplicar Configuração Agora
                            </button>

                            <button class="btn btn-warning" style="font-size: 16px; padding: 12px; width: 100%; margin-bottom: 20px;" onclick="quickSwitchToJSONBin()">
                                ⚡ Voltar Rápido para JSONBin.io
                            </button>

                            <div style="padding: 15px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50;">
                                <strong>🚀 Como Funciona:</strong>
                                <ol style="margin: 10px 0 0 20px; line-height: 1.8;">
                                    <li>Escolha o tipo de API (JSONBin ou Servidor Customizado)</li>
                                    <li>Configure as URLs se necessário</li>
                                    <li>Clique em "🔄 Aplicar Configuração Agora"</li>
                                    <li><strong>Web:</strong> Passa a usar as novas URLs imediatamente (GET/POST)</li>
                                    <li><strong>Unity:</strong> O navegador vai pedir para salvar o arquivo <code>api-config.json</code></li>
                                    <li>Salve o arquivo em: <code>Build/StreamingAssets/api-config.json</code></li>
                                    <li>Pronto! Unity lerá na próxima vez que abrir</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dynamic API Configuration - Can be changed via config tab
        let API_CONFIG = {
            apiType: 'jsonbin', // 'jsonbin' or 'customServer'
            jsonbin: {
                apiKey: '$2a$10$Uu3NdRpmfPSc0b2MNV0PY.mKluWPCevjK7ioHlXr4AlMca/HC2V9y',
                baseUrl: 'https://api.jsonbin.io/v3/b',
                quizBinId: '68e7598543b1c97be95fbb4d',
                rankingBinId: '68e75972ae596e708f0b701f',
                registrationBinId: '68ed827aae596e708f1217dc'
            },
            customServer: {
                baseUrl: 'https://jogos.clickideia.com.br',
                quizEndpoint: '/QuizData.json',
                rankingEndpoint: '/RankingData.json',
                registrationEndpoint: '/Register.json'
            }
        };

        // Helper functions to get URLs based on current config
        function getQuizURL() {
            if (API_CONFIG.apiType === 'jsonbin') {
                return `${API_CONFIG.jsonbin.baseUrl}/${API_CONFIG.jsonbin.quizBinId}/latest`;
            } else {
                return `${API_CONFIG.customServer.baseUrl}${API_CONFIG.customServer.quizEndpoint}`;
            }
        }

        function getRankingURL() {
            if (API_CONFIG.apiType === 'jsonbin') {
                return `${API_CONFIG.jsonbin.baseUrl}/${API_CONFIG.jsonbin.rankingBinId}/latest`;
            } else {
                return `${API_CONFIG.customServer.baseUrl}${API_CONFIG.customServer.rankingEndpoint}`;
            }
        }

        function getRegistrationURL() {
            if (API_CONFIG.apiType === 'jsonbin') {
                return `${API_CONFIG.jsonbin.baseUrl}/${API_CONFIG.jsonbin.registrationBinId}/latest`;
            } else {
                return `${API_CONFIG.customServer.baseUrl}${API_CONFIG.customServer.registrationEndpoint}`;
            }
        }

        function getRequestHeaders(isUpdate = false) {
            const headers = {};
            if (API_CONFIG.apiType === 'jsonbin') {
                headers['X-Master-Key'] = API_CONFIG.jsonbin.apiKey;
                headers['X-Bin-Meta'] = 'false';
                if (isUpdate) {
                    headers['Content-Type'] = 'application/json';
                }
            } else {
                headers['Content-Type'] = 'application/json';
            }
            return headers;
        }

        function getUpdateURL(type) {
            if (API_CONFIG.apiType === 'jsonbin') {
                let binId;
                if (type === 'quiz') binId = API_CONFIG.jsonbin.quizBinId;
                else if (type === 'ranking') binId = API_CONFIG.jsonbin.rankingBinId;
                else if (type === 'registration') binId = API_CONFIG.jsonbin.registrationBinId;
                return `${API_CONFIG.jsonbin.baseUrl}/${binId}`;
            } else {
                if (type === 'quiz') return `${API_CONFIG.customServer.baseUrl}${API_CONFIG.customServer.quizEndpoint}`;
                else if (type === 'ranking') return `${API_CONFIG.customServer.baseUrl}${API_CONFIG.customServer.rankingEndpoint}`;
                else if (type === 'registration') return `${API_CONFIG.customServer.baseUrl}${API_CONFIG.customServer.registrationEndpoint}`;
            }
        }

        let quizData = null;
        let editingQuestionId = null;
        let editingGroupId = null;
        let currentImageData = null; // { base64, dataUrl, mimeType, filename, originalName }
        let imageRemoved = false;
        let currentTab = 'groups';
        let currentFilterGroupId = '';

        // Image handling functions
        function setupImageUpload() {
            const imageInput = document.getElementById('questionImage');
            const uploadArea = document.getElementById('imageUploadArea');

            // File input change event
            imageInput.addEventListener('change', handleImageUpload);

            // Drag and drop events
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleImageFile(files[0]);
                }
            });
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                handleImageFile(file);
            }
        }

        function handleImageFile(file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showAlert('Por favor, selecione apenas arquivos de imagem.', 'error');
                return;
            }

            // Validate file size (2MB max)
            if (file.size > 2 * 1024 * 1024) {
                showAlert('A imagem deve ter no máximo 2MB.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const dataUrl = e.target.result;
                const base64Data = dataUrl.includes(',') ? dataUrl.split(',')[1] : dataUrl;
                const mimeType = file.type || 'image/png';
                const filename = generateImageFilename(file.name);

                currentImageData = {
                    filename: filename,
                    base64: base64Data,
                    dataUrl: dataUrl,
                    mimeType: mimeType,
                    originalName: file.name
                };

                imageRemoved = false;

                showImagePreview(currentImageData.dataUrl);
            };
            reader.readAsDataURL(file);
        }

        function generateImageFilename(originalName) {
            const extension = originalName.split('.').pop();
            return `question_${Date.now()}.${extension}`;
        }

        function showImagePreview(imageSrc) {
            const container = document.getElementById('imagePreviewContainer');
            container.innerHTML = `
                <img src="${imageSrc}" alt="Preview" class="image-preview">
                <br>
                <button type="button" class="image-upload-btn" onclick="document.getElementById('questionImage').click()">
                    🔄 Trocar Imagem
                </button>
                <button type="button" class="image-remove-btn" onclick="removeImage()">
                    🗑️ Remover
                </button>
                <p style="margin-top: 10px; font-size: 14px; color: #666;">
                    ${currentImageData.originalName}
                </p>
            `;
        }

        function removeImage() {
            currentImageData = null;
            imageRemoved = true;
            const container = document.getElementById('imagePreviewContainer');
            container.innerHTML = `
                <p>🖼️ Clique para adicionar uma imagem ou arraste aqui</p>
                <input type="file" id="questionImage" accept="image/*" style="display: none;">
                <button type="button" class="image-upload-btn" onclick="document.getElementById('questionImage').click()">
                    📎 Escolher Imagem
                </button>
            `;
            // Reattach event listener
            document.getElementById('questionImage').addEventListener('change', handleImageUpload);
        }

        function buildDataUrl(base64, mimeType = 'image/png') {
            if (!base64) return null;
            return `data:${mimeType};base64,${base64}`;
        }

        function getExtensionFromMime(mimeType) {
            if (!mimeType) return 'png';

            const normalized = mimeType.toLowerCase();
            if (normalized.includes('jpeg') || normalized.includes('jpg')) return 'jpg';
            if (normalized.includes('png')) return 'png';
            if (normalized.includes('gif')) return 'gif';
            if (normalized.includes('bmp')) return 'bmp';
            if (normalized.includes('webp')) return 'webp';
            return 'png';
        }

        function normalizeLegacyImage(question) {
            if (!question) return;

            // Already in new format
            if (question.imageBase64) {
                question.imageMimeType = question.imageMimeType || 'image/png';
                if (!question.imageFilename && question.imageOriginalName) {
                    const extension = question.imageOriginalName.split('.').pop();
                    question.imageFilename = `question_${question.id || Date.now()}.${extension || 'png'}`;
                }
                return;
            }

            if (question.image) {
                const legacyData = question.image.data || question.image.originalData || question.image.base64;
                if (legacyData) {
                    const base64 = legacyData.includes(',') ? legacyData.split(',')[1] : legacyData;
                    let mimeType = question.image.mimeType;

                    if (!mimeType && typeof legacyData === 'string' && legacyData.startsWith('data:')) {
                        const semiIndex = legacyData.indexOf(';');
                        if (semiIndex > 5) {
                            mimeType = legacyData.substring(5, semiIndex);
                        }
                    }

                    question.imageBase64 = base64;
                    question.imageMimeType = mimeType || 'image/png';
                    question.imageOriginalName = question.image.originalName || question.image.filename || question.imageFilename || 'imagem.png';

                    if (!question.imageFilename) {
                        const legacyFilename = question.image.filename || '';
                        const legacyOriginal = question.imageOriginalName || legacyFilename;
                        const inferredExtension = legacyFilename ? legacyFilename.split('.').pop()
                            : legacyOriginal ? legacyOriginal.split('.').pop()
                                : getExtensionFromMime(question.imageMimeType);

                        question.imageFilename = `question_${question.id || Date.now()}.${inferredExtension || getExtensionFromMime(question.imageMimeType)}`;
                    }
                }

                delete question.image;
            }
        }

        // Tab switching
        function switchTab(tabName) {
            currentTab = tabName;

            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            if (tabName === 'groups') {
                document.getElementById('groupsTab').classList.add('active');
            } else if (tabName === 'questions') {
                document.getElementById('questionsTab').classList.add('active');
            } else if (tabName === 'ranking') {
                document.getElementById('rankingTab').classList.add('active');
                loadRanking(); // Carregar ranking ao abrir a aba
            } else if (tabName === 'config') {
                document.getElementById('configTab').classList.add('active');
                updateCurrentConfigDisplay();
            }
        }

        // Config Tab Functions
        function toggleAPIConfig() {
            const selectedType = document.querySelector('input[name="apiType"]:checked').value;

            if (selectedType === 'jsonbin') {
                document.getElementById('jsonbinConfig').style.display = 'block';
                document.getElementById('customServerConfig').style.display = 'none';
            } else {
                document.getElementById('jsonbinConfig').style.display = 'none';
                document.getElementById('customServerConfig').style.display = 'block';
            }

            updateCurrentConfigDisplay();
        }

        function updateCurrentConfigDisplay() {
            const selectedType = document.querySelector('input[name="apiType"]:checked').value;
            const configDiv = document.getElementById('currentConfig');

            let configText = '';
            if (selectedType === 'jsonbin') {
                configText = `
API Type: JSONBin.io
Quiz URL: ${API_CONFIG.jsonbin.baseUrl}/${document.getElementById('jsonbinQuizBinId').value}/latest
Ranking URL: ${API_CONFIG.jsonbin.baseUrl}/${document.getElementById('jsonbinRankingBinId').value}/latest
Registration URL: ${API_CONFIG.jsonbin.baseUrl}/${document.getElementById('jsonbinRegistrationBinId').value}/latest
                `.trim();
            } else {
                const baseUrl = document.getElementById('customBaseUrl').value;
                const quizEndpoint = document.getElementById('customQuizEndpoint').value;
                const rankingEndpoint = document.getElementById('customRankingEndpoint').value;
                const registrationEndpoint = document.getElementById('customRegistrationEndpoint').value;

                configText = `
API Type: Servidor Customizado
Quiz URL: ${baseUrl}${quizEndpoint}
Ranking URL: ${baseUrl}${rankingEndpoint}
Registration URL: ${baseUrl}${registrationEndpoint}
                `.trim();
            }

            configDiv.textContent = configText;
        }

        function quickSwitchToJSONBin() {
            // Marcar radio button JSONBin
            document.querySelector('input[name="apiType"][value="jsonbin"]').checked = true;
            toggleAPIConfig();

            // Aplicar configuração
            API_CONFIG.apiType = 'jsonbin';

            console.log('⚡ Voltando para JSONBin.io...');
            showAlert('⚡ Voltando para JSONBin.io...', 'success');

            // Recarregar dados
            setTimeout(() => {
                loadQuestions();
                if (currentTab === 'ranking') {
                    loadRanking();
                }
            }, 500);
        }

        async function applyConfigAndReload() {
            const selectedType = document.querySelector('input[name="apiType"]:checked').value;

            // Atualizar configuração global
            API_CONFIG.apiType = selectedType;

            // Atualizar valores do JSONBin (se foram editados)
            API_CONFIG.jsonbin.apiKey = document.getElementById('jsonbinApiKey').value;
            API_CONFIG.jsonbin.quizBinId = document.getElementById('jsonbinQuizBinId').value;
            API_CONFIG.jsonbin.rankingBinId = document.getElementById('jsonbinRankingBinId').value;
            API_CONFIG.jsonbin.registrationBinId = document.getElementById('jsonbinRegistrationBinId').value;

            // Atualizar valores do Custom Server
            API_CONFIG.customServer.baseUrl = document.getElementById('customBaseUrl').value;
            API_CONFIG.customServer.quizEndpoint = document.getElementById('customQuizEndpoint').value;
            API_CONFIG.customServer.rankingEndpoint = document.getElementById('customRankingEndpoint').value;
            API_CONFIG.customServer.registrationEndpoint = document.getElementById('customRegistrationEndpoint').value;

            console.log('✅ Configuração atualizada:', API_CONFIG);

            // Salvar arquivo no StreamingAssets
            await saveConfigToFile();

            showAlert('✅ Configuração aplicada! Recarregando dados...', 'success');

            // Recarregar todos os dados com a nova configuração
            setTimeout(() => {
                loadQuestions();
                if (currentTab === 'ranking') {
                    loadRanking();
                }
            }, 500);
        }

        async function saveConfigToFile() {
            const config = {
                apiType: API_CONFIG.apiType,
                jsonbin: {
                    apiKey: API_CONFIG.jsonbin.apiKey,
                    baseUrl: API_CONFIG.jsonbin.baseUrl,
                    quizBinId: API_CONFIG.jsonbin.quizBinId,
                    rankingBinId: API_CONFIG.jsonbin.rankingBinId,
                    registrationBinId: API_CONFIG.jsonbin.registrationBinId
                },
                customServer: {
                    baseUrl: API_CONFIG.customServer.baseUrl,
                    quizEndpoint: API_CONFIG.customServer.quizEndpoint,
                    rankingEndpoint: API_CONFIG.customServer.rankingEndpoint,
                    registrationEndpoint: API_CONFIG.customServer.registrationEndpoint
                }
            };

            const json = JSON.stringify(config, null, 2);
            const blob = new Blob([json], { type: 'application/json' });

            try {
                // Tentar usar File System Access API (Chrome moderno)
                if ('showSaveFilePicker' in window) {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: 'api-config.json',
                        types: [{
                            description: 'JSON Config File',
                            accept: { 'application/json': ['.json'] }
                        }]
                    });

                    const writable = await handle.createWritable();
                    await writable.write(blob);
                    await writable.close();

                    console.log('✅ Arquivo salvo via File System Access API');
                    showAlert('💾 Arquivo salvo! Coloque em: Build/StreamingAssets/api-config.json', 'success');
                } else {
                    // Fallback: download automático
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'api-config.json';
                    link.click();
                    URL.revokeObjectURL(url);

                    console.log('✅ Arquivo baixado automaticamente');
                    showAlert('💾 Arquivo baixado! Coloque em: Build/StreamingAssets/api-config.json', 'success');
                }
            } catch (error) {
                console.warn('⚠️ Salvamento cancelado ou não suportado:', error.message);
            }
        }


        // Update config display when custom server fields change
        document.addEventListener('DOMContentLoaded', function() {
            const customFields = ['customBaseUrl', 'customQuizEndpoint', 'customRankingEndpoint', 'customRegistrationEndpoint'];
            customFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', updateCurrentConfigDisplay);
                }
            });

            // Initialize config display on page load
            updateCurrentConfigDisplay();
        });

        // Schedule management functions
        function dateTimeToUnixTimestamp(dateStr, timeStr) {
            if (!dateStr || !timeStr) return 0;

            // Combinar data e hora em formato ISO
            const dateTimeStr = `${dateStr}T${timeStr}:00`;
            const date = new Date(dateTimeStr);

            // Retornar timestamp em segundos (não milissegundos)
            return Math.floor(date.getTime() / 1000);
        }

        function unixTimestampToDateTime(timestamp) {
            if (!timestamp || timestamp === 0) return { date: '', time: '' };

            // Converter de segundos para milissegundos
            const date = new Date(timestamp * 1000);

            // Formatar data (YYYY-MM-DD)
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;

            // Formatar hora (HH:MM)
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const timeStr = `${hours}:${minutes}`;

            return { date: dateStr, time: timeStr };
        }

        function formatDateTimeBR(timestamp) {
            if (!timestamp || timestamp === 0) return 'Não configurado';

            const date = new Date(timestamp * 1000);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');

            return `${day}/${month}/${year} às ${hours}:${minutes}`;
        }

        function updateScheduleDisplay() {
            if (!quizData) return;

            const statusDiv = document.getElementById('scheduleStatus');
            const startTimestamp = quizData.startTimestamp || 0;
            const endTimestamp = quizData.endTimestamp || 0;

            if (startTimestamp === 0 && endTimestamp === 0) {
                statusDiv.innerHTML = '✅ <strong style="color: #28a745;">Quiz sempre disponível</strong>';
                return;
            }

            const now = Math.floor(Date.now() / 1000);
            let statusHtml = '<div style="line-height: 1.8;">';

            if (startTimestamp > 0) {
                statusHtml += `📅 <strong>Início:</strong> ${formatDateTimeBR(startTimestamp)}<br>`;
            }

            if (endTimestamp > 0) {
                statusHtml += `📅 <strong>Término:</strong> ${formatDateTimeBR(endTimestamp)}<br>`;
            }

            // Verificar status atual
            if (startTimestamp > 0 && now < startTimestamp) {
                const diffMinutes = Math.floor((startTimestamp - now) / 60);
                const diffHours = Math.floor(diffMinutes / 60);
                const diffDays = Math.floor(diffHours / 24);

                let timeLeft = '';
                if (diffDays > 0) {
                    timeLeft = `${diffDays} dia(s)`;
                } else if (diffHours > 0) {
                    timeLeft = `${diffHours} hora(s)`;
                } else {
                    timeLeft = `${diffMinutes} minuto(s)`;
                }

                statusHtml += `<br>⏳ <strong style="color: #ffa726;">Quiz ainda não começou</strong> (faltam ${timeLeft})`;
            } else if (endTimestamp > 0 && now > endTimestamp) {
                statusHtml += `<br>🔒 <strong style="color: #dc3545;">Quiz encerrado</strong>`;
            } else {
                statusHtml += `<br>✅ <strong style="color: #28a745;">Quiz disponível agora!</strong>`;
            }

            statusHtml += '</div>';
            statusDiv.innerHTML = statusHtml;

            // Preencher os campos de data/hora
            if (startTimestamp > 0) {
                const startDateTime = unixTimestampToDateTime(startTimestamp);
                document.getElementById('startDate').value = startDateTime.date;
                document.getElementById('startTime').value = startDateTime.time;
            }

            if (endTimestamp > 0) {
                const endDateTime = unixTimestampToDateTime(endTimestamp);
                document.getElementById('endDate').value = endDateTime.date;
                document.getElementById('endTime').value = endDateTime.time;
            }
        }

        function saveSchedule() {
            const startDate = document.getElementById('startDate').value;
            const startTime = document.getElementById('startTime').value;
            const endDate = document.getElementById('endDate').value;
            const endTime = document.getElementById('endTime').value;

            // Converter para timestamps
            const startTimestamp = dateTimeToUnixTimestamp(startDate, startTime);
            const endTimestamp = dateTimeToUnixTimestamp(endDate, endTime);

            // Validar que fim é depois do início (se ambos configurados)
            if (startTimestamp > 0 && endTimestamp > 0 && endTimestamp <= startTimestamp) {
                showAlert('A data/hora de término deve ser posterior à de início!', 'error');
                return;
            }

            // Atualizar quizData
            if (!quizData) {
                quizData = {
                    title: "Quiz ClickDescubra 2025",
                    startTimestamp: 0,
                    endTimestamp: 0,
                    groups: [],
                    questions: []
                };
            }

            quizData.startTimestamp = startTimestamp;
            quizData.endTimestamp = endTimestamp;

            // Salvar na API
            saveQuestions().then(() => {
                updateScheduleDisplay();
                showAlert('Agendamento salvo com sucesso!', 'success');
            });
        }

        function clearSchedule() {
            if (!confirm('Tem certeza que deseja remover o agendamento? O quiz ficará sempre disponível.')) {
                return;
            }

            // Limpar campos
            document.getElementById('startDate').value = '';
            document.getElementById('startTime').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('endTime').value = '';

            // Atualizar quizData
            if (quizData) {
                quizData.startTimestamp = 0;
                quizData.endTimestamp = 0;
            }

            // Salvar na API
            saveQuestions().then(() => {
                updateScheduleDisplay();
                showAlert('Agendamento removido! Quiz agora está sempre disponível.', 'success');
            });
        }

        // Load questions on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadQuestions();
            setupImageUpload();
        });

        async function loadQuestions() {
            setStatus('loading', 'Carregando perguntas...');

            try {
                const response = await fetch(getQuizURL(), {
                    method: 'GET',
                    headers: getRequestHeaders()
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                quizData = await response.json();

                // Converter JSON antigo (questions) para novo formato (groups)
                if (quizData && !quizData.groups && quizData.questions) {
                    console.log('⚠️ JSON antigo detectado - convertendo para formato de grupos');
                    quizData.groups = [{
                        id: 'group1',
                        name: '',
                        completionMessage: 'Parabéns! Você completou este grupo!',
                        questions: quizData.questions
                    }];
                }

                // Garantir que groups existe
                if (!quizData.groups) {
                    quizData.groups = [];
                }

                // Garantir que campos de agendamento existem
                if (quizData.startTimestamp === undefined) {
                    quizData.startTimestamp = 0;
                }
                if (quizData.endTimestamp === undefined) {
                    quizData.endTimestamp = 0;
                }

                // Normalizar imagens
                if (quizData && quizData.groups) {
                    quizData.groups.forEach(group => {
                        if (group.questions) {
                            group.questions.forEach(normalizeLegacyImage);
                        }
                    });
                }

                const totalQuestions = quizData.groups.reduce((sum, g) => sum + (g.questions?.length || 0), 0);
                setStatus('success', `✅ ${quizData.groups.length} grupos e ${totalQuestions} perguntas carregadas`);

                displayGroups();
                displayQuestions();
                updateStats();
                updateGroupSelector();
                updateScheduleDisplay();

            } catch (error) {
                console.error('Error loading questions:', error);

                // Detectar erro CORS
                if (error.message.includes('Failed to fetch') || error.toString().includes('NetworkError')) {
                    setStatus('error', '❌ Erro CORS - Configure o servidor!');
                    showAlert('⚠️ Erro de CORS detectado!\n\nO servidor precisa ter os headers:\n- Access-Control-Allow-Origin: *\n- Access-Control-Allow-Methods: GET, POST, OPTIONS\n- Access-Control-Allow-Headers: Content-Type\n\nOu volte para JSONBin.io na aba de Configurações.', 'error');
                } else {
                    setStatus('error', '❌ Erro ao carregar perguntas');
                }
                showAlert('Erro ao carregar perguntas: ' + error.message, 'error');
            }
        }

        async function saveQuestions() {
            setStatus('loading', 'Salvando alterações...');

            try {
                // Process images before saving
                processImagesForSaving();

                const response = await fetch(getUpdateURL('quiz'), {
                    method: 'POST',
                    headers: getRequestHeaders(true),
                    body: JSON.stringify(quizData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                setStatus('success', '✅ Alterações salvas com sucesso');
                showAlert('Perguntas salvas com sucesso!', 'success');

            } catch (error) {
                console.error('Error saving questions:', error);
                setStatus('error', '❌ Erro ao salvar');
                showAlert('Erro ao salvar: ' + error.message, 'error');
            }
        }

        function processImagesForSaving() {
            if (!quizData || !quizData.groups) return;

            quizData.groups.forEach(group => {
                if (!group.questions) return;

                group.questions.forEach(question => {
                    normalizeLegacyImage(question);

                    if (question.imageBase64) {
                        question.imageMimeType = question.imageMimeType || 'image/png';
                        if (!question.imageFilename) {
                            const extension = (question.imageOriginalName || 'imagem.png').split('.').pop();
                            question.imageFilename = `question_${question.id || Date.now()}.${extension || 'png'}`;
                        }
                    }
                });
            });

            // Manter questions para compatibilidade (todas as questões de todos os grupos)
            quizData.questions = [];
            quizData.groups.forEach(group => {
                if (group.questions) {
                    quizData.questions = quizData.questions.concat(group.questions);
                }
            });
        }

        function downloadAllImages() {
            if (!quizData || !quizData.questions) return;

            const imagesWithData = quizData.questions.filter(q => q.imageBase64);

            if (imagesWithData.length === 0) {
                showAlert('Nenhuma imagem encontrada para download.', 'info');
                return;
            }

            let downloadCount = 0;
            imagesWithData.forEach((question, index) => {
                setTimeout(() => {
                    const dataUrl = buildDataUrl(question.imageBase64, question.imageMimeType || 'image/png');
                    const filename = question.imageFilename || `question_${question.id || index}.png`;

                    const link = document.createElement('a');
                    link.href = dataUrl;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    downloadCount++;

                    if (downloadCount === imagesWithData.length) {
                        showAlert(`${downloadCount} imagens exportadas.`, 'success');
                    }
                }, index * 200);
            });
        }

        // Group management functions
        function addGroup() {
            const groupName = document.getElementById('groupName').value.trim();
            const groupMessage = document.getElementById('groupMessage').value.trim();

            if (!groupMessage) {
                showAlert('Por favor, digite a mensagem de conclusão.', 'error');
                return;
            }

            if (!quizData) {
                quizData = {
                    title: "Quiz ClickDescubra 2025",
                    groups: [],
                    questions: []
                };
            }

            if (!quizData.groups) {
                quizData.groups = [];
            }

            if (quizData.groups.length >= 5) {
                showAlert('Máximo de 5 grupos atingido!', 'error');
                return;
            }

            const newGroup = {
                id: 'group' + (Date.now()),
                name: groupName || '', // Vazio = usa "Grupo X"
                completionMessage: groupMessage,
                questions: []
            };

            quizData.groups.push(newGroup);

            clearGroupForm();
            resetToAddGroupMode();

            saveQuestions().then(() => {
                displayGroups();
                updateStats();
                updateGroupSelector();
            });

            showAlert('Grupo adicionado com sucesso!', 'success');
        }

        function editGroup(groupId) {
            const group = quizData.groups.find(g => g.id === groupId);
            if (!group) {
                showAlert('Grupo não encontrado!', 'error');
                return;
            }

            editingGroupId = groupId;
            document.getElementById('groupFormTitle').textContent = '✏️ Editar Grupo';

            document.getElementById('groupName').value = group.name || '';
            document.getElementById('groupMessage').value = group.completionMessage || '';

            document.getElementById('groupFormActions').innerHTML = `
                <button class="btn btn-success" onclick="updateGroup()">
                    💾 Salvar Alterações
                </button>
                <button class="btn btn-danger" onclick="cancelGroupEdit()">
                    ❌ Cancelar
                </button>
            `;

            document.getElementById('groupFormTitle').scrollIntoView({ behavior: 'smooth' });
        }

        function updateGroup() {
            const groupName = document.getElementById('groupName').value.trim();
            const groupMessage = document.getElementById('groupMessage').value.trim();

            if (!groupMessage) {
                showAlert('Por favor, digite a mensagem de conclusão.', 'error');
                return;
            }

            const groupIndex = quizData.groups.findIndex(g => g.id === editingGroupId);
            if (groupIndex === -1) {
                showAlert('Grupo não encontrado!', 'error');
                return;
            }

            quizData.groups[groupIndex].name = groupName || '';
            quizData.groups[groupIndex].completionMessage = groupMessage;

            clearGroupForm();
            resetToAddGroupMode();

            saveQuestions().then(() => {
                displayGroups();
                updateStats();
                updateGroupSelector();
            });

            showAlert('Grupo atualizado com sucesso!', 'success');
        }

        function deleteGroup(groupId) {
            const group = quizData.groups.find(g => g.id === groupId);
            if (!group) return;

            const questionCount = group.questions?.length || 0;
            if (questionCount > 0) {
                if (!confirm(`Este grupo tem ${questionCount} pergunta(s). Tem certeza que deseja excluir?`)) {
                    return;
                }
            } else {
                if (!confirm('Tem certeza que deseja excluir este grupo?')) {
                    return;
                }
            }

            quizData.groups = quizData.groups.filter(g => g.id !== groupId);

            saveQuestions().then(() => {
                displayGroups();
                updateStats();
                updateGroupSelector();
            });

            showAlert('Grupo excluído com sucesso!', 'success');
        }

        function cancelGroupEdit() {
            clearGroupForm();
            resetToAddGroupMode();
        }

        function clearGroupForm() {
            document.getElementById('groupName').value = '';
            document.getElementById('groupMessage').value = '';
        }

        function resetToAddGroupMode() {
            editingGroupId = null;
            document.getElementById('groupFormTitle').textContent = '➕ Adicionar Novo Grupo';
            document.getElementById('groupFormActions').innerHTML = `
                <button class="btn btn-primary" onclick="addGroup()">
                    ➕ Adicionar Grupo
                </button>
            `;
        }

        function displayGroups() {
            const container = document.getElementById('groupsList');

            if (!quizData || !quizData.groups || quizData.groups.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Nenhum grupo criado. Adicione o primeiro grupo!</p>';
                return;
            }

            container.innerHTML = quizData.groups.map((group, index) => {
                const displayName = group.name || `Grupo ${index + 1}`;
                const questionCount = group.questions?.length || 0;

                return `
                    <div class="group-card">
                        <div class="group-header">
                            <div class="group-title">${displayName}</div>
                            <div class="group-actions">
                                <button class="btn btn-primary btn-small" onclick="editGroup('${group.id}')">
                                    ✏️ Editar
                                </button>
                                <button class="btn btn-danger btn-small" onclick="deleteGroup('${group.id}')">
                                    🗑️ Excluir
                                </button>
                            </div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Mensagem:</strong> ${group.completionMessage || 'Sem mensagem'}
                        </div>
                        <div style="color: #666;">
                            <strong>${questionCount}</strong> pergunta(s) neste grupo
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateGroupSelector() {
            const select = document.getElementById('questionGroup');
            if (!select) return;

            const currentValue = select.value;

            if (!quizData || !quizData.groups || quizData.groups.length === 0) {
                select.innerHTML = '<option value="">Nenhum grupo disponível - crie um grupo primeiro</option>';
                return;
            }

            select.innerHTML = '<option value="">Selecione um grupo...</option>' +
                quizData.groups.map((group, index) => {
                    const displayName = group.name || `Grupo ${index + 1}`;
                    return `<option value="${group.id}">${displayName}</option>`;
                }).join('');

            // Restaurar valor selecionado se possível
            if (currentValue) {
                select.value = currentValue;
            }

            // Atualizar também o filtro de grupos
            updateFilterGroupSelector();
        }

        function updateFilterGroupSelector() {
            const filterSelect = document.getElementById('filterGroup');
            if (!filterSelect) return;

            const currentValue = currentFilterGroupId || filterSelect.value;

            if (!quizData || !quizData.groups || quizData.groups.length === 0) {
                filterSelect.innerHTML = '<option value="">Nenhum grupo disponível</option>';
                return;
            }

            filterSelect.innerHTML = '<option value="">Todos os Grupos</option>' +
                quizData.groups.map((group, index) => {
                    const displayName = group.name || `Grupo ${index + 1}`;
                    return `<option value="${group.id}">${displayName}</option>`;
                }).join('');

            if (currentValue) {
                filterSelect.value = currentValue;
            }
        }

        function filterQuestionsByGroup() {
            const filterSelect = document.getElementById('filterGroup');
            currentFilterGroupId = filterSelect.value;
            displayQuestions();
        }

        function moveQuestionToGroup(questionId) {
            // Encontrar a questão atual e seu grupo
            let currentGroup = null;
            let question = null;

            for (const group of quizData.groups) {
                if (group.questions) {
                    const found = group.questions.find(q => q.id === questionId);
                    if (found) {
                        question = found;
                        currentGroup = group;
                        break;
                    }
                }
            }

            if (!question || !currentGroup) {
                showAlert('Questão não encontrada!', 'error');
                return;
            }

            // Criar opções de grupos (exceto o atual)
            const groupOptions = quizData.groups
                .filter(g => g.id !== currentGroup.id)
                .map((group, index) => {
                    const displayName = group.name || `Grupo ${quizData.groups.indexOf(group) + 1}`;
                    return `<option value="${group.id}">${displayName}</option>`;
                })
                .join('');

            if (!groupOptions) {
                showAlert('Não há outros grupos disponíveis!', 'error');
                return;
            }

            // Criar um modal simples para selecionar o grupo destino
            const currentGroupName = currentGroup.name || `Grupo ${quizData.groups.indexOf(currentGroup) + 1}`;
            const targetGroupId = prompt(`Mover questão do grupo "${currentGroupName}" para qual grupo?\n\nDigite o número do grupo (1-${quizData.groups.length}):`);

            if (!targetGroupId) return;

            const targetIndex = parseInt(targetGroupId) - 1;
            if (isNaN(targetIndex) || targetIndex < 0 || targetIndex >= quizData.groups.length) {
                showAlert('Número de grupo inválido!', 'error');
                return;
            }

            const targetGroup = quizData.groups[targetIndex];
            if (targetGroup.id === currentGroup.id) {
                showAlert('A questão já está neste grupo!', 'error');
                return;
            }

            // Mover a questão
            const questionIndex = currentGroup.questions.findIndex(q => q.id === questionId);
            currentGroup.questions.splice(questionIndex, 1);

            if (!targetGroup.questions) {
                targetGroup.questions = [];
            }
            targetGroup.questions.push(question);

            // Salvar e atualizar
            saveQuestions().then(() => {
                displayGroups();
                displayQuestions();
                updateStats();

                const targetGroupName = targetGroup.name || `Grupo ${targetIndex + 1}`;
                showAlert(`Questão movida para "${targetGroupName}" com sucesso!`, 'success');
            });
        }

        function addQuestion() {
            const questionText = document.getElementById('questionText').value.trim();
            const option0 = document.getElementById('option0').value.trim();
            const option1 = document.getElementById('option1').value.trim();
            const option2 = document.getElementById('option2').value.trim();
            const option3 = document.getElementById('option3').value.trim();
            const selectedGroupId = document.getElementById('questionGroup').value;
            const category = document.getElementById('category').value.trim();
            const timeSeconds = parseInt(document.getElementById('timeSeconds').value);
            const correctOption = document.querySelector('input[name="correctOption"]:checked');

            // Validation
            if (!questionText) {
                showAlert('Por favor, digite a pergunta.', 'error');
                return;
            }

            if (!option0 || !option1 || !option2 || !option3) {
                showAlert('Por favor, preencha todas as 4 opções.', 'error');
                return;
            }

            if (!correctOption) {
                showAlert('Por favor, selecione a resposta correta.', 'error');
                return;
            }

            if (!selectedGroupId) {
                showAlert('Por favor, selecione um grupo.', 'error');
                return;
            }

            if (!category) {
                showAlert('Por favor, digite a categoria.', 'error');
                return;
            }

            if (!quizData) {
                quizData = {
                    title: "Quiz ClickDescubra 2025",
                    groups: [],
                    questions: []
                };
            }

            if (!quizData.groups) {
                quizData.groups = [];
            }

            // Encontrar o grupo selecionado
            const group = quizData.groups.find(g => g.id === selectedGroupId);
            if (!group) {
                showAlert('Grupo não encontrado!', 'error');
                return;
            }

            if (!group.questions) {
                group.questions = [];
            }

            // Create new question
            const newQuestion = {
                id: 'q' + (Date.now()),
                question: questionText,
                options: [option0, option1, option2, option3],
                correctIndex: parseInt(correctOption.value),
                timeSeconds: timeSeconds,
                category: category
            };

            // Add image if provided
            if (currentImageData && currentImageData.base64) {
                newQuestion.imageBase64 = currentImageData.base64;
                newQuestion.imageMimeType = currentImageData.mimeType;
                newQuestion.imageFilename = currentImageData.filename;
                newQuestion.imageOriginalName = currentImageData.originalName;
            }

            group.questions.push(newQuestion);

            // Clear form and reset to add mode
            clearForm();
            resetToAddMode();

            // Save and refresh
            saveQuestions().then(() => {
                displayGroups();
                displayQuestions();
                updateStats();
            });

            showAlert('Pergunta adicionada com sucesso!', 'success');
        }

        function editQuestion(questionId) {
            // Procurar a pergunta em todos os grupos
            let question = null;
            let groupId = null;

            for (const group of quizData.groups) {
                if (group.questions) {
                    const found = group.questions.find(q => q.id === questionId);
                    if (found) {
                        question = found;
                        groupId = group.id;
                        break;
                    }
                }
            }

            if (!question) {
                showAlert('Pergunta não encontrada!', 'error');
                return;
            }

            // Set form to edit mode
            editingQuestionId = questionId;
            document.getElementById('formTitle').textContent = '✏️ Editar Pergunta';

            // Fill form with question data
            document.getElementById('questionText').value = question.question;
            document.getElementById('option0').value = question.options[0];
            document.getElementById('option1').value = question.options[1];
            document.getElementById('option2').value = question.options[2];
            document.getElementById('option3').value = question.options[3];
            document.getElementById('questionGroup').value = groupId;
            document.getElementById('category').value = question.category;
            document.getElementById('timeSeconds').value = question.timeSeconds;

            // Set correct option
            document.getElementById(`correct${question.correctIndex}`).checked = true;

            // Load image if exists
            normalizeLegacyImage(question);
            imageRemoved = false;

            if (question.imageBase64) {
                const mimeType = question.imageMimeType || 'image/png';
                const dataUrl = buildDataUrl(question.imageBase64, mimeType);
                const fallbackName = question.imageOriginalName || question.imageFilename || `${question.id || 'imagem'}.png`;
                const filename = question.imageFilename || generateImageFilename(fallbackName);

                currentImageData = {
                    filename: filename,
                    base64: question.imageBase64,
                    dataUrl: dataUrl,
                    mimeType: mimeType,
                    originalName: fallbackName
                };

                showImagePreview(dataUrl);
            } else if (question.imageFilename) {
                // Only has filename reference - show placeholder
                const container = document.getElementById('imagePreviewContainer');
                container.innerHTML = `
                    <div style="padding: 20px; background: #f0f0f0; border-radius: 8px; text-align: center;">
                        <p style="margin: 0; color: #666;">🖼️ Imagem vinculada: <strong>${question.imageFilename}</strong></p>
                        <small style="color: #999;">Para alterar, faça upload de uma nova imagem</small>
                        <br><br>
                        <button type="button" class="image-upload-btn" onclick="document.getElementById('questionImage').click()">
                            🔄 Trocar Imagem
                        </button>
                        <button type="button" class="image-remove-btn" onclick="removeImage()">
                            🗑️ Remover
                        </button>
                    </div>
                `;
                currentImageData = null;
            } else {
                removeImage();
                imageRemoved = false;
            }

            // Update form buttons
            document.getElementById('formActions').innerHTML = `
                <button class="btn btn-success" onclick="updateQuestion()">
                    💾 Salvar Alterações
                </button>
                <button class="btn btn-danger" onclick="cancelEdit()">
                    ❌ Cancelar
                </button>
            `;

            // Scroll to form
            document.getElementById('formTitle').scrollIntoView({ behavior: 'smooth' });
        }

        function updateQuestion() {
            const questionText = document.getElementById('questionText').value.trim();
            const option0 = document.getElementById('option0').value.trim();
            const option1 = document.getElementById('option1').value.trim();
            const option2 = document.getElementById('option2').value.trim();
            const option3 = document.getElementById('option3').value.trim();
            const selectedGroupId = document.getElementById('questionGroup').value;
            const category = document.getElementById('category').value.trim();
            const timeSeconds = parseInt(document.getElementById('timeSeconds').value);
            const correctOption = document.querySelector('input[name="correctOption"]:checked');

            // Validation
            if (!questionText) {
                showAlert('Por favor, digite a pergunta.', 'error');
                return;
            }

            if (!option0 || !option1 || !option2 || !option3) {
                showAlert('Por favor, preencha todas as 4 opções.', 'error');
                return;
            }

            if (!correctOption) {
                showAlert('Por favor, selecione a resposta correta.', 'error');
                return;
            }

            if (!selectedGroupId) {
                showAlert('Por favor, selecione um grupo.', 'error');
                return;
            }

            if (!category) {
                showAlert('Por favor, digite a categoria.', 'error');
                return;
            }

            // Find the question in all groups
            let foundGroup = null;
            let questionIndex = -1;

            for (const group of quizData.groups) {
                if (group.questions) {
                    questionIndex = group.questions.findIndex(q => q.id === editingQuestionId);
                    if (questionIndex !== -1) {
                        foundGroup = group;
                        break;
                    }
                }
            }

            if (!foundGroup || questionIndex === -1) {
                showAlert('Pergunta não encontrada!', 'error');
                return;
            }

            const updatedQuestion = {
                id: editingQuestionId,
                question: questionText,
                options: [option0, option1, option2, option3],
                correctIndex: parseInt(correctOption.value),
                timeSeconds: timeSeconds,
                category: category
            };

            if (currentImageData && currentImageData.base64) {
                updatedQuestion.imageBase64 = currentImageData.base64;
                updatedQuestion.imageMimeType = currentImageData.mimeType;
                updatedQuestion.imageFilename = currentImageData.filename;
                updatedQuestion.imageOriginalName = currentImageData.originalName;
            } else if (!imageRemoved) {
                const previous = foundGroup.questions[questionIndex];
                if (previous.imageBase64) {
                    updatedQuestion.imageBase64 = previous.imageBase64;
                    updatedQuestion.imageMimeType = previous.imageMimeType;
                    updatedQuestion.imageFilename = previous.imageFilename;
                    updatedQuestion.imageOriginalName = previous.imageOriginalName;
                } else if (previous.imageFilename) {
                    updatedQuestion.imageFilename = previous.imageFilename;
                    updatedQuestion.imageOriginalName = previous.imageOriginalName;
                }
            } else {
                updatedQuestion.imageBase64 = null;
                updatedQuestion.imageMimeType = null;
                updatedQuestion.imageFilename = null;
                updatedQuestion.imageOriginalName = null;
            }

            // Se mudou de grupo, remover do grupo antigo e adicionar no novo
            if (foundGroup.id !== selectedGroupId) {
                foundGroup.questions.splice(questionIndex, 1);
                const newGroup = quizData.groups.find(g => g.id === selectedGroupId);
                if (newGroup) {
                    if (!newGroup.questions) newGroup.questions = [];
                    newGroup.questions.push(updatedQuestion);
                }
            } else {
                foundGroup.questions[questionIndex] = updatedQuestion;
            }

            // Clear form and reset to add mode
            clearForm();
            resetToAddMode();

            // Save and refresh
            saveQuestions().then(() => {
                displayGroups();
                displayQuestions();
                updateStats();
            });

            showAlert('Pergunta atualizada com sucesso!', 'success');
        }

        function cancelEdit() {
            clearForm();
            resetToAddMode();
        }

        function clearForm() {
            document.getElementById('questionText').value = '';
            document.getElementById('option0').value = '';
            document.getElementById('option1').value = '';
            document.getElementById('option2').value = '';
            document.getElementById('option3').value = '';
            document.getElementById('category').value = '';
            document.getElementById('timeSeconds').value = '20';

            // Clear radio buttons
            const checkedRadio = document.querySelector('input[name="correctOption"]:checked');
            if (checkedRadio) {
                checkedRadio.checked = false;
            }

            // Clear image
            removeImage();
            imageRemoved = false;
        }

        function resetToAddMode() {
            editingQuestionId = null;
            document.getElementById('formTitle').textContent = '➕ Adicionar Nova Pergunta';
            document.getElementById('formActions').innerHTML = `
                <button class="btn btn-primary" onclick="addQuestion()">
                    ➕ Adicionar Pergunta
                </button>
            `;
        }

        function deleteQuestion(questionId) {
            if (!confirm('Tem certeza que deseja excluir esta pergunta?')) {
                return;
            }

            if (quizData && quizData.groups) {
                // Procurar e remover a pergunta do grupo
                for (const group of quizData.groups) {
                    if (group.questions) {
                        const index = group.questions.findIndex(q => q.id === questionId);
                        if (index !== -1) {
                            group.questions.splice(index, 1);
                            break;
                        }
                    }
                }

                saveQuestions().then(() => {
                    displayGroups();
                    displayQuestions();
                    updateStats();
                });

                showAlert('Pergunta excluída com sucesso!', 'success');
            }
        }

        function displayQuestions() {
            const container = document.getElementById('questionsList');

            if (!quizData || !quizData.groups || quizData.groups.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Nenhuma pergunta encontrada.</p>';
                return;
            }

            // Coletar todas as perguntas de todos os grupos
            const allQuestionsWithGroup = [];
            quizData.groups.forEach((group, groupIndex) => {
                const groupName = group.name || `Grupo ${groupIndex + 1}`;
                if (group.questions) {
                    group.questions.forEach(question => {
                        allQuestionsWithGroup.push({
                            question,
                            groupName,
                            groupId: group.id
                        });
                    });
                }
            });

            // Aplicar filtro se houver
            let filteredQuestions = allQuestionsWithGroup;
            if (currentFilterGroupId) {
                filteredQuestions = allQuestionsWithGroup.filter(item => item.groupId === currentFilterGroupId);
            }

            if (filteredQuestions.length === 0) {
                const message = currentFilterGroupId
                    ? 'Nenhuma pergunta encontrada neste grupo.'
                    : 'Nenhuma pergunta encontrada.';
                container.innerHTML = `<p style="text-align: center; color: #666; padding: 40px;">${message}</p>`;
                return;
            }

            container.innerHTML = filteredQuestions.map(({ question, groupName }) => `
                <div class="question-card">
                    <div class="question-header">
                        <div class="question-title">${question.question}</div>
                    </div>
                    <div class="question-meta">
                        <strong>Grupo:</strong> ${groupName} |
                        <strong>Categoria:</strong> ${question.category} |
                        <strong>Tempo:</strong> ${question.timeSeconds}s |
                        <strong>ID:</strong> ${question.id}
                    </div>
                    ${question.imageBase64 ? `
                        <div style="margin: 10px 0; text-align: center;">
                            <img src="${buildDataUrl(question.imageBase64, question.imageMimeType || 'image/png')}" alt="Imagem da pergunta" class="question-image">
                            <p style="font-size: 12px; color: #666; margin: 5px 0;">${question.imageOriginalName || question.imageFilename || 'imagem.png'}</p>
                        </div>
                    ` : question.imageFilename ? `
                        <div class="no-image-placeholder">
                            📁 Imagem externa: ${question.imageFilename}
                        </div>
                    ` : `
                        <div class="no-image-placeholder">
                            📷 Sem imagem
                        </div>
                    `}
                    <div class="question-options">
                        ${question.options.map((option, index) => `
                            <div class="option ${index === question.correctIndex ? 'correct' : 'incorrect'}">
                                ${index === question.correctIndex ? '✓' : '○'} ${option}
                            </div>
                        `).join('')}
                    </div>
                    <div class="question-actions">
                        <button class="btn btn-primary btn-small" onclick="editQuestion('${question.id}')">
                            ✏️ Editar
                        </button>
                        <button class="btn btn-warning btn-small" onclick="moveQuestionToGroup('${question.id}')">
                            📦 Mover
                        </button>
                        <button class="btn btn-danger btn-small" onclick="deleteQuestion('${question.id}')">
                            🗑️ Excluir
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            if (!quizData || !quizData.groups) {
                document.getElementById('totalGroups').textContent = '0';
                document.getElementById('totalQuestions').textContent = '0';
                document.getElementById('categoriesCount').textContent = '0';
                document.getElementById('avgTime').textContent = '0s';
                return;
            }

            const totalGroups = quizData.groups.length;

            // Coletar todas as perguntas de todos os grupos
            const allQuestions = [];
            quizData.groups.forEach(group => {
                if (group.questions) {
                    allQuestions.push(...group.questions);
                }
            });

            const totalQuestions = allQuestions.length;
            const categories = new Set(allQuestions.map(q => q.category)).size;
            const avgTime = allQuestions.length > 0 ?
                Math.round(allQuestions.reduce((sum, q) => sum + q.timeSeconds, 0) / allQuestions.length) : 0;

            document.getElementById('totalGroups').textContent = totalGroups;
            document.getElementById('totalQuestions').textContent = totalQuestions;
            document.getElementById('categoriesCount').textContent = categories;
            document.getElementById('avgTime').textContent = avgTime + 's';
        }

        function setStatus(type, message) {
            const icon = document.getElementById('statusIcon');
            const text = document.getElementById('statusText');

            icon.className = `status-icon ${type}`;
            text.textContent = message;
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;

            container.innerHTML = '';
            container.appendChild(alertDiv);

            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Ranking functions
        let rankingData = null;
        let registrationData = null;

        async function loadRanking() {
            try {
                setStatus('loading', 'Carregando ranking...');

                console.log('🔄 Carregando ranking...');

                // Carregar ranking
                const rankingResponse = await fetch(getRankingURL(), {
                    headers: getRequestHeaders()
                });

                console.log('Ranking response status:', rankingResponse.status);

                if (!rankingResponse.ok) {
                    const errorText = await rankingResponse.text();
                    console.error('Erro ao carregar ranking:', errorText);
                    throw new Error(`Erro ao carregar ranking: ${rankingResponse.status}`);
                }

                rankingData = await rankingResponse.json();
                console.log('✅ Ranking carregado:', rankingData);

                // Carregar registros
                const registrationResponse = await fetch(getRegistrationURL(), {
                    headers: getRequestHeaders()
                });

                console.log('Registration response status:', registrationResponse.status);

                if (!registrationResponse.ok) {
                    const errorText = await registrationResponse.text();
                    console.error('Erro ao carregar registros:', errorText);
                    throw new Error(`Erro ao carregar registros: ${registrationResponse.status}`);
                }

                registrationData = await registrationResponse.json();
                console.log('✅ Registros carregados:', registrationData);

                displayRanking();
                setStatus('success', '✅ Ranking carregado');

            } catch (error) {
                console.error('❌ Erro ao carregar ranking:', error);
                setStatus('error', '❌ Erro ao carregar ranking');
                showAlert('Erro ao carregar ranking: ' + error.message, 'error');
            }
        }

        function displayRanking() {
            const tbody = document.getElementById('rankingTableBody');

            if (!rankingData || !rankingData.entries || rankingData.entries.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                            Nenhum jogador no ranking ainda.
                        </td>
                    </tr>
                `;
                updateRankingStats([]);
                return;
            }

            // Ordenar por pontuação (desc) e depois por tempo (asc)
            const sortedEntries = [...rankingData.entries].sort((a, b) => {
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                return a.totalTimeSeconds - b.totalTimeSeconds;
            });

            // Criar mapa de registros por ID para acesso rápido
            const registrationMap = {};
            if (registrationData && registrationData.players) {
                registrationData.players.forEach(player => {
                    registrationMap[player.id] = player;
                });
            }

            tbody.innerHTML = sortedEntries.map((entry, index) => {
                const registration = registrationMap[entry.id] || {};
                const position = index + 1;
                const medal = position === 1 ? '🥇' : position === 2 ? '🥈' : position === 3 ? '🥉' : `${position}º`;
                const timeFormatted = formatTime(entry.totalTimeSeconds);
                const phone = registration.ddd && registration.phone ? `(${registration.ddd}) ${registration.phone}` : '-';

                const rowColor = position === 1 ? '#fff9db' :
                                position === 2 ? '#f0f0f0' :
                                position === 3 ? '#ffe4cc' : 'white';

                return `
                    <tr style="background: ${rowColor}; border-bottom: 1px solid #e9ecef;">
                        <td style="padding: 15px; font-weight: bold; font-size: 18px;">${medal}</td>
                        <td style="padding: 15px;">${entry.playerName || registration.name || '-'}</td>
                        <td style="padding: 15px;">${registration.email || '-'}</td>
                        <td style="padding: 15px;">${phone}</td>
                        <td style="padding: 15px;">${registration.cargo || '-'}</td>
                        <td style="padding: 15px; text-align: center; font-weight: bold; color: #4facfe;">${entry.score}</td>
                        <td style="padding: 15px; text-align: center;">${timeFormatted}</td>
                    </tr>
                `;
            }).join('');

            updateRankingStats(sortedEntries);
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        function updateRankingStats(entries) {
            const statsDiv = document.getElementById('rankingStats');

            if (!entries || entries.length === 0) {
                statsDiv.innerHTML = '';
                return;
            }

            const totalPlayers = entries.length;
            const avgScore = (entries.reduce((sum, e) => sum + e.score, 0) / totalPlayers).toFixed(1);
            const avgTime = (entries.reduce((sum, e) => sum + e.totalTimeSeconds, 0) / totalPlayers).toFixed(1);
            const highestScore = entries[0].score;

            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalPlayers}</div>
                    <div class="stat-label">Total de Jogadores</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${highestScore}</div>
                    <div class="stat-label">Maior Pontuação</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${avgScore}</div>
                    <div class="stat-label">Pontuação Média</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${formatTime(avgTime)}</div>
                    <div class="stat-label">Tempo Médio</div>
                </div>
            `;
        }

        function exportRankingToCSV() {
            if (!rankingData || !rankingData.entries || rankingData.entries.length === 0) {
                showAlert('Nenhum dado para exportar!', 'error');
                return;
            }

            // Ordenar por pontuação
            const sortedEntries = [...rankingData.entries].sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return a.totalTimeSeconds - b.totalTimeSeconds;
            });

            // Criar mapa de registros
            const registrationMap = {};
            if (registrationData && registrationData.players) {
                registrationData.players.forEach(player => {
                    registrationMap[player.id] = player;
                });
            }

            // Cabeçalho do CSV
            let csv = 'Colocação,Nome,Email,Telefone,Cargo,Pontuação,Tempo (segundos)\n';

            // Adicionar dados
            sortedEntries.forEach((entry, index) => {
                const registration = registrationMap[entry.id] || {};
                const position = index + 1;
                const phone = registration.ddd && registration.phone ? `(${registration.ddd}) ${registration.phone}` : '';

                csv += `${position},"${entry.playerName || registration.name || ''}","${registration.email || ''}","${phone}","${registration.cargo || ''}",${entry.score},${entry.totalTimeSeconds.toFixed(2)}\n`;
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `ranking_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showAlert('Ranking exportado com sucesso!', 'success');
        }
    </script>
</body>

</html>